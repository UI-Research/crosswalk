---
title: "Standardizing Longitudinal Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Standardizing Longitudinal Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Overview

A common challenge with longitudinal tract-level data is that census tract boundaries
change between decennial censuses. Data from before 2020 typically uses 2010 tract
definitions, while more recent data uses 2020 tract definitions. To analyze trends
over time, you need to standardize all years to a consistent tract vintage.

This vignette demonstrates how the `crosswalk` package efficiently handles this task
using the Urban Institute's [HMDA Neighborhood Summary Files](https://datacatalog.urban.org/dataset/home-mortgage-disclosure-act-neighborhood-summary-files-census-tract-level),
which provide tract-level mortgage lending data from 2018-2023. The 2018-2021 files
use 2010 tract definitions, while 2022-2023 use 2020 tract definitions.

## Setup

```{r setup, message=FALSE}
library(crosswalk)
library(dplyr)
library(purrr)
library(readr)
library(tibble)
library(stringr)
```

## Step 1: Download the Data

The Urban Institute publishes annual HMDA tract-level summary files. Let's download
all six years (2018-2023):

```{r download-data}
## metadata object describing data year/vintage/url
metadata = tibble::tribble(
  ~ year, ~ vintage, ~ url,
  2018, 2010, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2023/12/20/hmda_tract_2018.csv",
  2019, 2010, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2023/12/20/hmda_tract_2019.csv",
  2020, 2010, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2023/12/20/hmda_tract_2020.csv",
  2021, 2010, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2023/12/20/hmda_tract_2021.csv",
  2022, 2020, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2023/12/20/hmda_tract_2022.csv",
  2023, 2020, "https://urban-data-catalog.s3.amazonaws.com/drupal-root-live/2024/12/17/hmda_tract_2023.csv")

## iterate of the metadata object and read in data for each year
hmda_data <- pmap(metadata, function(url, year, vintage) {
  read_csv(url, show_col_types = FALSE) |>
    mutate(
      vintage = vintage,
      data_year = as.integer(year)) })

names(hmda_data) = metadata$year %>% as.character()
```

Let's inspect the structure of the data:

```{r inspect-data}
# Check dimensions of each year
map(hmda_data, dim)

# View the 2018 data (2010 tract vintage)
glimpse(hmda_data[["2018"]])
```

## Step 2: Prepare Data for Crosswalking

The HMDA data includes a `tractid` column that contains the 11-digit tract GEOID.
Let's prepare a subset of variables for crosswalking. We'll focus on count variables
(total applications by race/ethnicity) which require the `count_` prefix for automatic
detection by `crosswalk_data()`:

```{r prepare-data}
prepare_hmda <- function(data) {
  data |>
    rename_with(.cols = matches("^geo20"), .fn = ~ "source_geoid") |>
    select(
      source_geoid,
      vintage,
      data_year,
      # Count variables: rename with count_ prefix for automatic detection
      count_race_white_purchase = race_white_purchase,
      count_owner_purchase_originations = owner_purchase_originations,
      median_owner_loan_amount = owner_loan_amount_median
    ) |>
    mutate(source_geoid = as.character(source_geoid))
}

hmda_prepared <- map(hmda_data, prepare_hmda)
```

## Step 3: Obtain the 2010â†’2020 Tract Crosswalk

Here's where `crosswalk` shines. We need a single crosswalk to convert all 2010-vintage
tracts to 2020-vintage tracts. The package fetches this from IPUMS NHGIS:

```{r get-crosswalk}
tract_crosswalk <- get_crosswalk(
  source_geography = "tract",
  target_geography = "tract",
  source_year = 2010,
  target_year = 2020,
  weight = "population")

# View the crosswalk plan
tract_crosswalk$message
```

The crosswalk contains allocation factors that specify how to distribute values from
2010 tracts to 2020 tracts. When tract boundaries changed, a single 2010 tract may
map to multiple 2020 tracts (or vice versa), with allocation factors summing to 1.

## Step 4: Apply the Crosswalk to 2018-2021 Data

Now we apply the crosswalk to the four years of data that use 2010 tract definitions:

```{r apply-crosswalk}
# Years that need crosswalking (2010 vintage)
years_to_crosswalk <- c("2018", "2019", "2020", "2021")

# Apply crosswalk to each year
hmda_crosswalked <- map_if(
  .x = hmda_prepared, 
  .p = names(hmda_prepared) %in% years_to_crosswalk,
  .f = ~ crosswalk_data(
      data = .x,
      crosswalk = tract_crosswalk,
      geoid_column = "source_geoid",
      show_join_quality = TRUE)) 

## how many source records are we unable to crosswalk each year?
## excluding those with an "X"--which is used to retain valid observations
## that, in the source data, do not have a valid tract identifier--very few:
hmda_crosswalked |>
  map(~ 
    .x |> 
    attr("join_quality") |> 
    pluck("data_geoids_unmatched") %>%
    .[!str_detect(., "X")] |>
    length())

hmda_combined <- bind_rows(hmda_crosswalked) |>
  ## data for years that are crosswalked have slightly different/additional columsn
  mutate(
    geoid = if_else(is.na(geoid), source_geoid, geoid)) |>
  select(-c(geography_name, source_geoid, vintage)) |>
  arrange(geoid, data_year)

# View the result
glimpse(hmda_combined)
```


## Result: A Panel Dataset in 2020 Tract Definitions
We now have a single dataframe with all six years of HMDA data standardized to 2020
tract definitions:

```{r final-summary}
# Unique tracts per year
hmda_combined |>
  group_by(data_year) |>
  summarize(n_tracts = n_distinct(geoid))
```


